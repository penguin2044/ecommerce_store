<% breadcrumb :products %>
<div class="container">
  <h1>Into the Music - Musical Instruments & Accessories</h1>
  
  <!-- Search Bar with Category Filter -->
  <div class="search-container">
    <%= form_with url: root_path, method: :get, class: "search-form" do %>
      <div class="search-row">
        <%= text_field_tag :search, params[:search], 
            placeholder: "Search for instruments, brands, or keywords...", 
            class: "search-input" %>
        
        <%= select_tag :search_category_id, 
            options_from_collection_for_select(@categories, :id, :name, params[:search_category_id]), 
            { prompt: 'All Categories', class: 'search-category-select' } %>
        
        <%= submit_tag "Search", class: "search-btn" %>
      </div>
      
      <% if params[:search].present? || params[:search_category_id].present? %>
        <%= link_to "Clear Search", root_path, class: "clear-search-btn" %>
      <% end %>
    <% end %>
  </div>

  <!-- Search Results Info -->
  <% if @search_query.present? || params[:search_category_id].present? %>
    <div class="search-results-info">
      <p>
        Found <%= pluralize(@products.total_count, 'product') %>
        <% if @search_query.present? %>
          matching "<strong><%= @search_query %></strong>"
        <% end %>
        <% if params[:search_category_id].present? %>
          <% search_cat = Category.find_by(id: params[:search_category_id]) %>
          in <strong><%= search_cat&.name || 'selected category' %></strong>
        <% end %>
      </p>
    </div>
  <% end %>

  <!-- Recently Updated Products Section -->
  <% if @recently_updated_products.any? && @category.nil? && @search_query.nil? && params[:search_category_id].nil? %>
    <div class="featured-section">
      <h2 class="section-title">Recently Updated (Last 3 Days)</h2>
      <div class="featured-grid">
        <% @recently_updated_products.each do |product| %>
          <div class="product-card featured-card">
            <span class="featured-badge">Updated</span>
            <h3><%= link_to product.name, product_path(product) %></h3>
            <p class="category"><%= product.category.name %></p>
            <p class="description"><%= truncate(product.description, length: 80) %></p>
            <p class="price">
              <% if product.on_sale? %>
                <span class="original-price">$<%= number_with_precision(product.price, precision: 2) %></span>
                <span class="sale-price">$<%= number_with_precision(product.sale_price, precision: 2) %></span>
              <% else %>
                $<%= number_with_precision(product.price, precision: 2) %>
              <% end %>
            </p>
            <%= link_to 'View Details', product_path(product), class: 'btn' %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- On Sale Section -->
  <% if @on_sale_products.any? && @category.nil? && @search_query.nil? && params[:search_category_id].nil? %>
    <div class="sale-section">
      <h2 class="section-title">Hot Deals - On Sale Now!</h2>
      <div class="sale-grid">
        <% @on_sale_products.each do |product| %>
          <div class="product-card sale-card">
            <span class="sale-badge">Sale</span>
            <h3><%= link_to product.name, product_path(product) %></h3>
            <p class="category"><%= product.category.name %></p>
            <p class="description"><%= truncate(product.description, length: 80) %></p>
            <p class="price">
              <span class="original-price">$<%= number_with_precision(product.price, precision: 2) %></span>
              <span class="sale-price">$<%= number_with_precision(product.sale_price, precision: 2) %></span>
              <span class="savings-badge">Save <%= number_to_percentage(((product.price - product.sale_price) / product.price * 100), precision: 0) %></span>
            </p>
            <%= link_to 'View Details', product_path(product), class: 'btn' %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <!-- Category Navigation -->
  <div class="category-nav">
    <%= link_to 'All Products', root_path, class: @category.nil? ? 'category-link active' : 'category-link' %>
    <% @categories.each do |category| %>
      <%= link_to category.name, root_path(category_id: category.id), class: @category == category ? 'category-link active' : 'category-link' %>
    <% end %>
  </div>

  <!-- Category Title -->
  <% if @category %>
    <h2 class="category-title"><%= @category.name %></h2>
    <p class="category-description"><%= @category.description %></p>
  <% end %>

  <!-- All Products Title -->
  <% if @category.nil? && @search_query.nil? && params[:search_category_id].nil? %>
    <h2 class="section-title">All Products</h2>
  <% end %>

  <!-- Products Grid -->
  <div class="products-grid">
    <% if @products.any? %>
      <% @products.each do |product| %>
        <div class="product-card">
          <h3><%= link_to product.name, product_path(product) %></h3>
          <p class="category"><%= product.category.name %></p>
          <p class="description"><%= truncate(product.description, length: 100) %></p>
          <p class="price">
            <% if product.on_sale? %>
              <span class="original-price">$<%= number_with_precision(product.price, precision: 2) %></span>
              <span class="sale-price">$<%= number_with_precision(product.sale_price, precision: 2) %></span>
            <% else %>
              $<%= number_with_precision(product.price, precision: 2) %>
            <% end %>
          </p>
          <%= link_to 'View Details', product_path(product), class: 'btn' %>
        </div>
      <% end %>
    <% else %>
      <p class="no-products">
        <% if @search_query.present? %>
          No products found matching "<%= @search_query %>". Try a different search term.
        <% else %>
          No products found in this category.
        <% end %>
      </p>
    <% end %>
  </div>
  
  <!-- Pagination -->
  <% if @products.total_pages > 1 %>
    <div class="pagination-container">
      <%= paginate @products %>
    </div>
  <% end %>
</div>