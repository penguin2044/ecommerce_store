<% breadcrumb :products %>
<div class="container">
  <h1>Into the Music - Musical Instruments & Accessories</h1>
  
  <!-- Search Bar with Category Filter -->
  <div class="search-container">
    <%= form_with url: root_path, method: :get, class: "search-form" do %>
      <div class="row g-3">
        <div class="col-md-6">
          <%= text_field_tag :search, params[:search], 
              placeholder: "Search for instruments, brands, or keywords...", 
              class: "form-control search-input" %>
        </div>
        
        <div class="col-md-4">
          <%= select_tag :search_category_id, 
              options_from_collection_for_select(@categories, :id, :name, params[:search_category_id]), 
              { prompt: 'All Categories', label: 'search categories dropdown', class: 'form-select search-category-select' } %>
        </div>
        
        <div class="col-md-2">
          <%= submit_tag "Search", class: "btn btn-primary w-100 search-btn" %>
        </div>
      </div>
      
      <% if params[:search].present? || params[:search_category_id].present? %>
        <%= link_to "Clear Search", root_path, class: "btn btn-danger btn-sm mt-3 clear-search-btn" %>
      <% end %>
    <% end %>
  </div>

  <!-- Search Results Info -->
  <% if @search_query.present? || params[:search_category_id].present? %>
    <div class="alert alert-info search-results-info">
      <p class="mb-0">
        Found <%= pluralize(@products.total_count, 'product') %>
        <% if @search_query.present? %>
          matching "<strong><%= @search_query %></strong>"
        <% end %>
        <% if params[:search_category_id].present? %>
          <% search_cat = Category.find_by(id: params[:search_category_id]) %>
          in <strong><%= search_cat&.name || 'selected category' %></strong>
        <% end %>
      </p>
    </div>
  <% end %>

  <!-- Recently Updated Products Section -->
  <% if @recently_updated_products.any? && @category.nil? && @search_query.nil? && params[:search_category_id].nil? %>
    <div class="featured-section">
      <h2 class="section-title">Recently Updated (Last 3 Days)</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <% @recently_updated_products.each do |product| %>
          <div class="col">
            <div class="card h-100 product-card featured-card">
              <span class="featured-badge">Updated</span>
              <div class="card-body">
                <h3 class="card-title"><%= link_to product.name, product_path(product) %></h3>
                <p class="category text-muted"><%= product.category.name %></p>
                <p class="card-text description"><%= truncate(product.description, length: 80) %></p>
                <p class="price">
                  <% if product.on_sale? %>
                    <span class="original-price">$<%= number_with_precision(product.price, precision: 2) %></span>
                    <span class="sale-price">$<%= number_with_precision(product.sale_price, precision: 2) %></span>
                  <% else %>
                    $<%= number_with_precision(product.price, precision: 2) %>
                  <% end %>
                </p>
                <%= link_to 'View Details', product_path(product), class: 'btn btn-primary' %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- On Sale Section -->
  <% if @on_sale_products.any? && @category.nil? && @search_query.nil? && params[:search_category_id].nil? %>
    <div class="sale-section">
      <h2 class="section-title">Hot Deals - On Sale Now!</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <% @on_sale_products.each do |product| %>
          <div class="col">
            <div class="card h-100 product-card sale-card">
              <span class="sale-badge">Sale</span>
              <div class="card-body">
                <h3 class="card-title"><%= link_to product.name, product_path(product) %></h3>
                <p class="category text-muted"><%= product.category.name %></p>
                <p class="card-text description"><%= truncate(product.description, length: 80) %></p>
                <p class="price">
                  <span class="original-price">$<%= number_with_precision(product.price, precision: 2) %></span>
                  <span class="sale-price">$<%= number_with_precision(product.sale_price, precision: 2) %></span>
                  <span class="savings-badge">Save <%= number_to_percentage(((product.price - product.sale_price) / product.price * 100), precision: 0) %></span>
                </p>
                <%= link_to 'View Details', product_path(product), class: 'btn btn-primary' %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <!-- Category Navigation -->
  <div class="btn-group category-nav" role="group">
    <%= link_to 'All Products', root_path, class: "btn #{@category.nil? ? 'btn-primary' : 'btn-outline-primary'} category-link" %>
    <% @categories.each do |category| %>
      <%= link_to category.name, root_path(category_id: category.id), class: "btn #{@category == category ? 'btn-primary' : 'btn-outline-primary'} category-link" %>
    <% end %>
  </div>

  <!-- Category Title -->
  <% if @category %>
    <h2 class="category-title"><%= @category.name %></h2>
    <p class="category-description"><%= @category.description %></p>
  <% end %>

  <!-- All Products Title -->
  <% if @category.nil? && @search_query.nil? && params[:search_category_id].nil? %>
    <h2 class="section-title">All Products</h2>
  <% end %>

  <!-- Products Grid with Bootstrap Grid -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <% if @products.any? %>
      <% @products.each do |product| %>
        <div class="col">
          <%= render 'product_card', product: product %>
        </div>
      <% end %>
    <% else %>
      <div class="col-12">
        <div class="alert alert-warning text-center no-products">
          <% if @search_query.present? %>
            No products found matching "<%= @search_query %>". Try a different search term.
          <% else %>
            No products found in this category.
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Pagination -->
  <% if @products.total_pages > 1 %>
    <div class="pagination-container">
      <%= paginate @products %>
    </div>
  <% end %>
</div>